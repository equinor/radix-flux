apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: radix-operator
  namespace: default
spec:
  interval: 5m
  install:
    remediation:
      retries: 3
  chart:
    spec:
      chart: ./charts/radix-operator
      sourceRef:
        kind: GitRepository
        name: radix-operator
        namespace: flux-system
      valuesFiles:
        - ./charts/radix-operator/values.yaml
  values:
    image:
      repository: ${radix_acr_repo_url}/radix-operator
      tag: ${RADIX_OPERATOR_TAG}

    dnsZone: ${dnsZone} # set in configmap flux-system/radix-flux-config
    appAliasBaseURL: ${appAliasBaseURL}  # set in configmap flux-system/radix-flux-config
    prometheusName: ${prometheusName}  # set in configmap flux-system/radix-flux-config
    clusterType: ${clusterType}  # set in configmap flux-system/radix-flux-config
    clusterActiveEgressIps: ${activeClusterIPs}  # set in configmap flux-system/radix-flux-config
    clusterName: ${clusterName}  # set in configmap flux-system/radix-flux-config

    subscriptionId: ${AZ_SUBSCRIPTION_ID}
    tenantId: 3aa4a235-b6e2-48d5-9195-7fcf05b459b0
    radixZone: ${RADIX_ZONE}
    containerRegistry: ${radix_acr_repo_url}
    appContainerRegistry: ${RADIX_APP_ACR_REPO_URL}

    registrationControllerThreads: 21
    applicationControllerThreads: 21
    environmentControllerThreads: 21
    deploymentControllerThreads: 21
    jobControllerThreads: 21
    alertControllerThreads: 21
    kubeClientRateLimitBurst: 500
    kubeClientRateLimitQPS: 500
    externalRegistryDefaultAuthSecret: radix-external-registry-default-auth

    oauthProxyImage: quay.io/oauth2-proxy/oauth2-proxy:${OAUTH2PROXY_TAG}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
    oauthRedisImage: ${OAUTH2REDIS_IMAGE}:${OAUTH2REDIS_TAG}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
    pipelineImageTag: ${RADIX_PIPELINE_IMAGE_TAG}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
    buildahImageBuilder: ${RADIX_BUILDAH_IMAGE_BUILDER_IMAGE}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
    gitCloneNsLookupImage: ${RADIX_PIPELINE_GIT_CLONE_NSLOOKUP_IMAGE}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
    gitCloneGitImage: ${RADIX_PIPELINE_GIT_CLONE_GIT_IMAGE}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
    gitCloneBashImage: ${RADIX_PIPELINE_GIT_CLONE_BASH_IMAGE}  # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged

    resources:
      limits:
        cpu: "2"
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 1Gi

    app:
      limitrange:
        default:
          memory: 500Mi
      builder:
        resources:
          limits:
            memory: 5000M
          requests:
            memory: 800M
            cpu: 800m

    securityContext:
      readOnlyRootFilesystem: true

    seccompProfile:
      image:
        repository: docker.io/alpine
        tag: ${SECCOMP_IMAGE_TAG}
        pullSecrets:
        - "radix-external-registry-default-auth"
      installer:
        image: ${RADIX_SECCOMP_PROFILE_INSTALLER_IMAGE} # deprecated, remove after https://github.com/equinor/radix-flux/pull/2933 is merged
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 10Mi

    gitClone:
      image:
        tag: ${GIT_CLONE_TAG}
        repository: docker.io/alpine/git

    oauth2proxy:
      image:
        tag: ${OAUTH2PROXY_TAG}
        repository: quay.io/oauth2-proxy/oauth2-proxy

    oauth2redis:
      image:
        tag: ${OAUTH2REDIS_TAG}
        repository: docker.io/redis

    radixPipelineRunner:
      image:
        tag: "${RADIX_PIPELINE_IMAGE_TAG}"
        repository: ${radix_acr_repo_url}/radix-pipeline

    radixImageBuilder:
      image: 
        tag: ${RADIX_IMAGE_BUILDER_TAG}
        repository:  ${radix_acr_repo_url}/radix-image-builder

    radixBuildKitImageBuilder:
      image:
        tag: ${RADIX_BUILDKIT_IMAGE_BUILDER_TAG}
        repository: ${radix_acr_repo_url}/radix-buildkit-builder

    radixJobScheduler:
      image:
        tag: ${RADIX_JOB_SCHEDULER_IMAGE_TAG}
        repository: ${radix_acr_repo_url}/radix-job-scheduler

    radixGroups:
      user: 64b28659-4fe4-4222-8497-85dd7e43e25b

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/os
                  operator: In
                  values:
                    - linux
                - key: kubernetes.io/arch
                  operator: In
                  values:
                    - amd64

    podSecurityStandard: # Ref https://kubernetes.io/docs/concepts/security/pod-security-standards/
      enforce:
        level: baseline
        version: v1.23
      audit:
        level: restricted
        version: v1.23
      warn:
        level: restricted
        version: v1.23

    radixWebhook:
      enabled: true
      logLevel: info
      logPretty: false
      requireAdGroups: true
      requireConfigurationItem: true
      image:
        repository: ghcr.io/equinor/radix-webhook
        tag: ${RADIX_WEBHOOK_TAG}
