apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: radix-operator
  namespace: default
spec:
  interval: 5m
  install:
    remediation:
      retries: 3
  chartRef:
    kind: OCIRepository
    name: radix-operator-chart
    namespace: flux-system
  values:
    dnsZone: ${dnsZone} # set in configmap flux-system/radix-flux-config
    appAliasBaseURL: ${appAliasBaseURL} # set in configmap flux-system/radix-flux-config
    prometheusName: ${prometheusName} # set in configmap flux-system/radix-flux-config
    clusterType: ${clusterType} # set in configmap flux-system/radix-flux-config
    clusterActiveEgressIps: ${activeClusterIPs} # set in configmap flux-system/radix-flux-config
    clusterName: ${clusterName} # set in configmap flux-system/radix-flux-config

    subscriptionId: ${AZ_SUBSCRIPTION_ID}
    tenantId: 3aa4a235-b6e2-48d5-9195-7fcf05b459b0
    radixZone: ${RADIX_ZONE}
    containerRegistry: ${radix_acr_repo_url}
    appContainerRegistry: ${RADIX_APP_ACR_REPO_URL}

    registrationControllerThreads: 21
    applicationControllerThreads: 21
    environmentControllerThreads: 21
    deploymentControllerThreads: 21
    jobControllerThreads: 21
    alertControllerThreads: 21
    kubeClientRateLimitBurst: 500
    kubeClientRateLimitQPS: 500
    externalRegistryDefaultAuthSecret: radix-external-registry-default-auth

    resources:
      limits:
        cpu: "2"
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 1Gi

    app:
      limitrange:
        default:
          memory: 500Mi
      builder:
        resources:
          limits:
            memory: 10Gi
          requests:
            memory: 1Gi
            cpu: 800m

    securityContext:
      readOnlyRootFilesystem: true

    seccompProfile:
      image:
        repository: docker.io/alpine
        tag: ${SECCOMP_IMAGE_TAG}
        pullSecrets:
          - "radix-external-registry-default-auth"
      installer:
        resources:
          limits:
            cpu: 10m
            memory: 20Mi
          requests:
            cpu: 10m
            memory: 10Mi

    gitClone:
      image:
        tag: ${GIT_CLONE_TAG}
        repository: docker.io/alpine/git

    oauth2proxy:
      image:
        tag: ${OAUTH2PROXY_TAG}
        repository: quay.io/oauth2-proxy/oauth2-proxy

    oauth2redis:
      image:
        tag: ${OAUTH2REDIS_TAG}
        repository: docker.io/redis

    radixImageBuilder:
      image:
        tag: ${RADIX_IMAGE_BUILDER_TAG}

    radixBuildKitImageBuilder:
      image:
        tag: ${RADIX_BUILDKIT_IMAGE_BUILDER_TAG}

    radixJobScheduler:
      image:
        tag: ${RADIX_JOB_SCHEDULER_IMAGE_TAG}
        repository: ${radix_acr_repo_url}/radix-job-scheduler

    radixGroups: # deprecated: remove after https://github.com/equinor/radix-private/issues/443
      user: 64b28659-4fe4-4222-8497-85dd7e43e25b

    rbac:
      createApp:
        groups:
          - 64b28659-4fe4-4222-8497-85dd7e43e25b # Radix Platform Users
          - 4e1761bc-0c4f-4672-a16d-7f3d8608e366 # AZAPPL Radix Platform

    radixWebhook:
      enabled: true
      logLevel: info
      logPretty: false
      requireAdGroups: true
      requireConfigurationItem: true

    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/os
                  operator: In
                  values:
                    - linux
                - key: kubernetes.io/arch
                  operator: In
                  values:
                    - amd64

    podSecurityStandard: # Ref https://kubernetes.io/docs/concepts/security/pod-security-standards/
      enforce:
        level: baseline
        version: v1.23
      audit:
        level: restricted
        version: v1.23
      warn:
        level: restricted
        version: v1.23
