apiVersion: kustomize.toolkit.fluxcd.io/v1beta1
kind: Kustomization
metadata:
  name: flux-system
  namespace: flux-system
spec:
  postBuild:
    substituteFrom:
      - kind: ConfigMap
        name: radix-flux-config
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: blob-csi-driver
  namespace: kube-system
spec:
  chart:
    spec:
      version: v1.5.0 # https://github.com/kubernetes-sigs/blob-csi-driver/releases
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cert-manager
  namespace: cert-manager
spec:
  chart:
    spec:
      version: 1.5.4 # https://github.com/jetstack/cert-manager/releases
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dynatrace-operator
  namespace: dynatrace
spec:
  chart:
    spec:
      version: 0.2.3 # https://github.com/Dynatrace/helm-charts/releases
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: external-dns
  namespace: default
spec:
  chart:
    spec:
      version: 5.4.8 # helm search repo bitnami/external-dns
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
  namespace: default
spec:
  chart:
    spec:
      version: 6.16.13 # https://github.com/grafana/helm-charts/releases
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ingress-nginx
  namespace: default
spec:
  chart:
    spec:
      version: 3.39.0 # https://github.com/kubernetes/ingress-nginx/releases
  values:
    controller:
      autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 5
        targetCPUUtilizationPercentage: 80
        targetMemoryUtilizationPercentage: 80
      resources:
        limits:
          memory: 500Mi
        requests:
          cpu: 100m
          memory: 500Mi
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: default
spec:
  chart:
    spec:
      version: 19.0.2 # https://github.com/prometheus-community/helm-charts/releases
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kubed
  namespace: kube-system
spec:
  chart:
    spec:
      version: v0.12.0 # https://github.com/kubeops/kubed/releases
  values:
    config:
      clusterName: dev # Used for Kubed notification ...which we do not use.
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kured
  namespace: default
spec:
  chart:
    spec:
      version: 2.9.1 # helm search repo kured/kured
  values:
    extraArgs:
      start-time: 8am
      end-time: 4pm
      lock-ttl: 30m
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
  namespace: velero
spec:
  chart:
    spec:
      version: 2.23.12 # https://github.com/vmware-tanzu/helm-charts/releases
  values:
    initContainers:
      - name: radix-velero-plugin
        image: radixdev.azurecr.io/radix-velero-plugin:master-latest
        volumeMounts:
          - name: plugins
            mountPath: /target
    resources:
      limits:
        memory: 1024Mi
      requests:
        cpu: 100m
        memory: 512Mi
---
#########################################
#   RADIX ACR CLEANUP
#
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: GitRepository
metadata:
  name: radix-acr-cleanup
  namespace: flux-system
spec:
  ref:
    branch: master
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: radix-acr-cleanup
  namespace: default
spec:
  values:
    registry: radixdev
    deleteUntagged: false
    image:
      repository: radixdev.azurecr.io/radix-acr-cleanup
      tag: master-83a71f8a-1634201422 # {"$imagepolicy": "flux-system:radix-acr-cleanup:tag"}
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageUpdateAutomation
metadata:
  name: radix-acr-cleanup
  namespace: flux-system
spec:
  update:
    path: ./clusters/development
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: radix-acr-cleanup
  namespace: flux-system
spec:
  image: radixdev.azurecr.io/radix-acr-cleanup
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: radix-acr-cleanup
  namespace: flux-system
spec:
  filterTags:
    pattern: ^master-[a-f0-9]+-(?P<ts>[0-9]+)
---
#########################################
#   RADIX CICD CANARY
#
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: GitRepository
metadata:
  name: radix-cicd-canary
  namespace: flux-system
spec:
  ref:
    branch: master
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: radix-cicd-canary
  namespace: radix-cicd-canary
spec:
  values:
    radixApiPrefix: server-radix-api-qa
    radixWebhookPrefix: webhook-radix-github-webhook-qa
    image:
      repository: radixdev.azurecr.io/radix-cicd-canary
      tag: flux2-bbf79a9d-1633621053 # {"$imagepolicy": "flux-system:radix-cicd-canary:tag"}
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageUpdateAutomation
metadata:
  name: radix-cicd-canary
  namespace: flux-system
spec:
  update:
    path: ./clusters/development
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: radix-cicd-canary
  namespace: flux-system
spec:
  image: radixdev.azurecr.io/radix-cicd-canary
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: radix-cicd-canary
  namespace: flux-system
spec:
  filterTags:
    pattern: ^master-[a-f0-9]+-(?P<ts>[0-9]+) # flux2-37ba38c8-1632749264
---
#########################################
#   RADIX COST ALLOCATION
#
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: GitRepository
metadata:
  name: radix-cost-allocation
  namespace: flux-system
spec:
  ref:
    branch: master
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: radix-cost-allocation
  namespace: radix-cost-allocation
spec:
  values:
    image:
      repository: radixdev.azurecr.io/radix-cost-allocation
      tag: master-6f810e44-1634201432 # {"$imagepolicy": "flux-system:radix-cost-allocation:tag"}
    db:
      server: sql-radix-cost-allocation-dev.database.windows.net
    resources:
      limits:
        memory: 100Mi
      requests:
        memory: 100Mi
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageUpdateAutomation
metadata:
  name: radix-cost-allocation
  namespace: flux-system
spec:
  update:
    path: ./clusters/development
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: radix-cost-allocation
  namespace: flux-system
spec:
  image: radixdev.azurecr.io/radix-cost-allocation
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: radix-cost-allocation
  namespace: flux-system
spec:
  filterTags:
    pattern: ^master-[a-f0-9]+-(?P<ts>[0-9]+)
---
#########################################
#   RADIX OPERATOR
#
apiVersion: source.toolkit.fluxcd.io/v1beta1
kind: GitRepository
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  ref:
    branch: master
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: radix-operator
  namespace: default
spec:
  values:
    image:
      repository: radixdev.azurecr.io/radix-operator
      tag: master-0738ab20-1634201605 # {"$imagepolicy": "flux-system:radix-operator:tag"}
    activeClusterName: weekly-40
    resources:
      limits:
        memory: 1000Mi
      requests:
        memory: 1000Mi
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageUpdateAutomation
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  update:
    path: ./clusters/development
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImageRepository
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  image: radixdev.azurecr.io/radix-operator
---
apiVersion: image.toolkit.fluxcd.io/v1beta1
kind: ImagePolicy
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  filterTags:
    pattern: ^master-[a-f0-9]+-(?P<ts>[0-9]+)
