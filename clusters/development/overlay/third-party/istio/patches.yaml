apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: istio
  namespace: flux-system
spec:
  patches:
    - target:
        kind: HelmRelease
        name: istiod
        namespace: istio-system
      patch: |-
          apiVersion: helm.toolkit.fluxcd.io/v2
          kind: HelmRelease
          metadata:
            name: istiod
            namespace: istio-system
          spec:
            chart:
              spec:
                version: ${ISTIO_VERSION} # Set in postBuild development
    - target:
        kind: NetworkPolicy
        name: istiod
        namespace: istio-system
      patch: |-
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: istiod
            namespace: istio-system
          spec:
            ingress:
            - ports:
                - port: 15017
                  protocol: TCP
              from:
                - namespaceSelector:
                    matchLabels:
                      kubernetes.io/metadata.name: monitor
            - ports:
              - port: 15010
                protocol: TCP
              - port: 15011
                protocol: TCP
              - port: 15012
                protocol: TCP
              - port: 8080
                protocol: TCP
              - port: 15014
                protocol: TCP
            from:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: monitor
  
    # - target:
    #     kind: NetworkPolicy
    #     name: istiod
    #     namespace: istio-system
    #     group: networking.k8s.io
    #     version: v1
    #   patch: |-
    #     - op: replace
    #       path: /spec/ingress/0/from
    #       value:
    #         - namespaceSelector:
    #             matchLabels:
    #               kubernetes.io/metadata.name: monitor

    #     - op: add
    #       path: /spec/ingress/1/from
    #       value:
    #         - namespaceSelector:
    #             matchLabels:
    #               kubernetes.io/metadata.name: monitor



