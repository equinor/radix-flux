apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: istio
  namespace: flux-system
spec:
  patches:
    - target:
        kind: HelmRelease
        name: istiod
        namespace: istio-system
      patch: |-
          apiVersion: helm.toolkit.fluxcd.io/v2
          kind: HelmRelease
          metadata:
            name: istiod
            namespace: istio-system
          spec:
            chart:
              spec:
                version: ${ISTIO_VERSION} # Set in postBuild development
    - target:
        kind: NetworkPolicy
        name: istiod
        namespace: istio-system
      patch: |-
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: istiod
            namespace: istio-system
          spec:
            ingress:
            - from:
                - namespaceSelector:
                    matchLabels:
                      kubernetes.io/metadata.name: monitor
