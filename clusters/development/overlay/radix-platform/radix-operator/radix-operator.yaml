apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  interval: 10m0s
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./components/radix-platform/radix-operator
  prune: true
  postBuild:
    substitute:
      radix_acr_repo_url: ${radix_acr_repo_url}
      ACTIVE_CLUSTER: ${ACTIVE_CLUSTER}
    substituteFrom:
      - kind: ConfigMap
        name: radix-flux-config
  patches:
    - patch: |-
        apiVersion: source.toolkit.fluxcd.io/v1beta1
        kind: GitRepository
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          ref:
            branch: ${radix_operator_helm_chart_branch}
      target:
        kind: GitRepository
        name: radix-operator
        namespace: flux-system
    - patch: |-
        apiVersion: image.toolkit.fluxcd.io/v1beta1
        kind: ImageRepository
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          image: ${radix_acr_repo_url}/radix-operator
      target:
        kind: ImageRepository
        name: radix-operator
        namespace: flux-system
    - patch: |
        apiVersion: image.toolkit.fluxcd.io/v1beta1
        kind: ImagePolicy
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          filterTags:
            pattern: ^${radix_operator_image_tag_prefix}-[a-f0-9]+-(?P<ts>[0-9]+)
      target:
        kind: ImagePolicy
        name: radix-operator
        namespace: flux-system
