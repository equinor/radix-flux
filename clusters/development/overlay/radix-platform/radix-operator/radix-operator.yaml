apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  interval: 10m0s
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./components/radix-platform/radix-operator
  prune: true
  timeout: 2m0s
  patches:
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2beta1
        kind: HelmRelease
        metadata:
          name: radix-operator
          namespace: default
        spec:
          values:
            image:
              tag: master-1be2aa43-1646121755 # {"$imagepolicy": "flux-system:radix-operator:tag"}
            activeClusterName: ${ACTIVE_CLUSTER} # Set in postBuild development
            resources:
              limits:
                cpu: "2"
                memory: 1000Mi
              requests:
                cpu: 100m
                memory: 1000Mi
            subscriptionId: 16ede44b-1f74-40a5-b428-46cca9a5741b
            app:
              env:
                limitrange:
                  default:
                    memory: 1000Mi
            oauthProxyImage: quay.io/oauth2-proxy/oauth2-proxy:v7.2.0 #https://quay.io/repository/oauth2-proxy/oauth2-proxy?tag=latest&tab=tags
            service:
              annotations:
                metrics.dynatrace.com/scrape: "true"
                metrics.dynatrace.com/port: "9000"
      target:
        kind: HelmRelease
        name: ingress-nginx
        namespace: ingress-nginx
    - patch: |-
        apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
        kind: Kustomization
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          postBuild:
            substitute:
              radix_operator_helm_chart_branch: master
              radix_operator_image_tag_prefix: master
      target:
        kind: Kustomization
        name: radix-operator
        namespace: flux-system
