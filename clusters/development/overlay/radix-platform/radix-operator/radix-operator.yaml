apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: radix-operator
  namespace: flux-system
spec:
  interval: 10m0s
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./components/radix-platform/radix-operator
  prune: true
  timeout: 2m0s
  patches:
    - patch: |-
        apiVersion: helm.toolkit.fluxcd.io/v2beta1
        kind: HelmRelease
        metadata:
          name: radix-operator
          namespace: default
        spec:
          values:
            image:
              tag: master-1be2aa43-1646121755 # {"$imagepolicy": "flux-system:radix-operator:tag"}
            activeClusterName: ${ACTIVE_CLUSTER} # Set in postBuild development
            resources:
              limits:
                cpu: "2"
                memory: 1000Mi
              requests:
                cpu: 100m
                memory: 1000Mi
            subscriptionId: 16ede44b-1f74-40a5-b428-46cca9a5741b
            app:
              env:
                limitrange:
                  default:
                    memory: 1000Mi
            oauthProxyImage: quay.io/oauth2-proxy/oauth2-proxy:v7.2.0 #https://quay.io/repository/oauth2-proxy/oauth2-proxy?tag=latest&tab=tags
            service:
              annotations:
                metrics.dynatrace.com/scrape: "true"
                metrics.dynatrace.com/port: "9000"
      target:
        kind: HelmRelease
        name: radix-operator
        namespace: default
    - patch: |-
        apiVersion: source.toolkit.fluxcd.io/v1beta1
        kind: GitRepository
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          ref:
            branch: ${radix_operator_helm_chart_branch}
      target:
        kind: GitRepository
        name: radix-operator
        namespace: flux-system
    - patch: |-
        apiVersion: image.toolkit.fluxcd.io/v1beta1
        kind: ImageRepository
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          image: ${radix_acr_repo_url}/radix-operator
      target:
        kind: ImageRepository
        name: radix-operator
        namespace: flux-system
    - patch: |
        apiVersion: image.toolkit.fluxcd.io/v1beta1
        kind: ImagePolicy
        metadata:
          name: radix-operator
          namespace: flux-system
        spec:
          filterTags:
            pattern: ^${radix_operator_image_tag_prefix}-[a-f0-9]+-(?P<ts>[0-9]+)
      target:
        kind: ImagePolicy
        name: radix-operator
        namespace: flux-system
