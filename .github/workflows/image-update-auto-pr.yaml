name: Image Update Auto-PR
on:
  push:
    branches: ['flux-image-updates']

jobs:
  pull-request:
    name: Open PR to master
    runs-on: ubuntu-latest
    env:
      PR_BRANCH: flux-pr-branch
    steps:
    - name: checkout
      uses: actions/checkout@v2

    - name: Get initial state
      id: get-initial-state
      run: |
        PR_STATE=$(gh pr view ${PR_BRANCH} --json state --jq '.state')
        echo "${PR_STATE}"
        echo '::set-output name=INITIAL_STATE::'${PR_STATE}''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Pull Request
      uses: equinor/OmniaAutomation/actions/create-pull-request/v3@f0c38caca6ad179872f43455bab4cf61047c6278
      with:
        Token: ${{ secrets.GITHUB_TOKEN }}
        title: "Automatic image update"
        body: |
          **Automatic image update**
        dedicatedBranch: ${{ env.PR_BRANCH }}
        destinationBranch: master
        force: true

    - name: Delete trigger branch
      run: |
        git push origin --delete ${GITHUB_REF_NAME}

    - name: Notify on slack
      if: ${{ steps.get-initial-state.outputs.INITIAL_STATE != 'OPEN' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_URL=$(gh pr view ${PR_BRANCH} --json url --jq .url)
        if [[ ${PR_URL} ]]; then
          curl --request POST \
            --header 'Content-type: application/json' \
            --data '{"text":"@omnia-radix Please review PR '${PR_URL}'","link_names":1}' \
            --url '${{ secrets.SLACK_WEBHOOK }}'
          exit 0
        else
          curl --request POST \
            --header 'Content-type: application/json' \
            --data '{"text":"@omnia-radix Creating PR from '${GITHUB_REF_NAME}' to master failed. https://github.com/'${GITHUB_REPOSITORY}'/actions/runs/'${GITHUB_RUN_ID}'","link_names":1}' \
            --url ${{ secrets.SLACK_WEBHOOK }}
          exit 1
        fi
