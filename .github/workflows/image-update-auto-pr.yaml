name: Image Update Auto-PR
on:
  push:
    branches: ['flux-image-updates']

jobs:
  pull-request:
    name: Open PR to master
    runs-on: ubuntu-latest
    env:
      PR_BRANCH: flux-image-updates
    steps:
    - name: checkout
      uses: actions/checkout@v2

    - name: Check for existing PR
      id: get-pr
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [[ $(git fetch origin && git branch --remotes) == *"origin/${PR_BRANCH}"* ]]; then
          PR_STATE=$(gh pr view ${PR_BRANCH} --json state --jq '.state')
        else
          PR_STATE="NONEXISTENT"
        fi
        echo "Pull request state: ${PR_STATE}"
        echo '::set-output name=STATE::'${PR_STATE}''

    - name: Create Pull Request
      if: ${{ steps.get-pr.outputs.STATE != 'OPEN' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Create PR"
        PR_URL=$(gh pr create --title "Automatic Pull Request" --base master --body "**Automatic Pull Request**")
        if [[ ${PR_URL} ]]; then
          curl --request POST \
            --header 'Content-type: application/json' \
            --data '{"text":"@omnia-radix Please review PR '${PR_URL}'","link_names":1}' \
            --url '${{ secrets.SLACK_WEBHOOK }}'
          exit 0
        else
          curl --request POST \
            --header 'Content-type: application/json' \
            --data '{"text":"@omnia-radix Creating PR from '${GITHUB_REF_NAME}' to master failed. https://github.com/'${GITHUB_REPOSITORY}'/actions/runs/'${GITHUB_RUN_ID}'","link_names":1}' \
            --url ${{ secrets.SLACK_WEBHOOK }}
          exit 1
        fi
